// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// --- Enums ---

enum StepType {
  claim_seat
  questionnaire
}

enum InputType {
  text
  number
  phone
  email
  select
  multiple_select @map("multiple-select")
  file
}

model Customer {
  id               String    @id @db.Uuid // References auth.users(id) 
  email            String    @unique
  fullName         String?   @map("full_name")
  phoneNumber      String?   @map("phone_number") @db.VarChar(20)
  blacklistedUntil DateTime? @map("blacklisted_until") @db.Timestamptz
  createdAt        DateTime? @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime? @default(now()) @map("updated_at") @db.Timestamptz

  registrations    EventRegistration[]

  @@map("customers")
}

model EventGroup {
  id                  Int      @id @default(autoincrement())
  groupName           String   @map("group_name") @db.VarChar(255)
  slug                String   @unique @db.VarChar(100)
  lockToSingleEvent   Boolean? @default(true) @map("lock_to_single_event")
  createdAt           DateTime? @default(now()) @map("created_at") @db.Timestamptz

  events              Event[]

  @@map("event_groups")
}

model Event {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  groupId     Int?     @map("group_id")
  slug        String   @unique @db.VarChar(100)
  title       String   @db.VarChar(255)
  description String?
  bannerPath  String?  @map("banner_path")
  isActive    Boolean? @default(true) @map("is_active")
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamptz

  group       EventGroup? @relation(fields: [groupId], references: [id], onDelete: Cascade)
  steps       RegistrationStep[]
  registrations EventRegistration[]

  @@map("events")
}

model RegistrationStep {
  id            Int      @id @default(autoincrement())
  eventId       String?  @map("event_id") @db.Uuid
  title         String   @db.VarChar(255)
  description   String?
  stepType      StepType? @map("step_type")
  orderPriority Int?     @default(0) @map("order_priority")
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime? @default(now()) @map("updated_at") @db.Timestamptz
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz

  event         Event?   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  questions     QuestionnaireQuestion[]
  seatConfigs   ClaimSeatConfig[]

  @@map("registration_steps")
}

model QuestionnaireQuestion {
  id            Int      @id @default(autoincrement())
  stepId        Int?     @map("step_id")
  label         String   @db.VarChar(100)
  questionText  String   @map("question_text")
  inputType     InputType? @map("input_type")
  options       Json?
  isRequired    Boolean? @default(true) @map("is_required")
  orderPriority Int?     @default(0) @map("order_priority")
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime? @default(now()) @map("updated_at") @db.Timestamptz
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz

  step          RegistrationStep? @relation(fields: [stepId], references: [id], onDelete: Cascade)
  answers       QuestionnaireAnswer[]

  @@map("questionnaire_questions")
}

model ClaimSeatConfig {
  id            Int      @id @default(autoincrement())
  stepId        Int?     @map("step_id")
  label         String   @db.VarChar(100)
  questionText  String   @map("question_text")
  inputType     InputType? @map("input_type")
  options       Json?
  placeholder   String?  @db.VarChar(255)
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime? @default(now()) @map("updated_at") @db.Timestamptz
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz

  step          RegistrationStep? @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@map("claim_seat_configs")
}

model EventRegistration {
  id             Int      @id @default(autoincrement())
  eventId        String?  @map("event_id") @db.Uuid
  customerId     String?  @map("customer_id") @db.Uuid
  claimSeatValue String   @map("claim_seat_value") @db.VarChar(255)
  qrCodeData     String   @unique @map("qr_code_data")
  status         String?  @default("active") @db.VarChar(50)
  registeredAt   DateTime? @default(now()) @map("registered_at") @db.Timestamptz

  event          Event?   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  customer       Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)
  answers        QuestionnaireAnswer[]

  @@unique([customerId, eventId])
  @@unique([eventId, claimSeatValue])
  @@map("event_registrations")
}

model QuestionnaireAnswer {
  id             Int      @id @default(autoincrement())
  registrationId Int?     @map("registration_id")
  questionId     Int?     @map("question_id")
  answerValue    String   @map("answer_value")
  createdAt      DateTime? @default(now()) @map("created_at") @db.Timestamptz

  question       QuestionnaireQuestion? @relation(fields: [questionId], references: [id], onDelete: Cascade)
  registration   EventRegistration?    @relation(fields: [registrationId], references: [id], onDelete: Cascade)

  @@map("questionnaire_answers")
}
